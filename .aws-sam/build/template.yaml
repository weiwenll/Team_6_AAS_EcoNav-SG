AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Travel Planner with Isolated Dependencies
Globals:
  Function:
    Runtime: python3.11
    Architectures:
    - x86_64
    Timeout: 120
    MemorySize: 1024
    Environment:
      Variables:
        USE_S3: 'true'
        AWS_REGION:
          Ref: AWS::Region
        PYTHONPATH: /opt/python:/var/runtime:/var/task
        AWS_S3_ENDPOINT:
          Ref: AwsS3Endpoint
Parameters:
  OpenAIKey:
    Type: String
    NoEcho: true
  ModelName:
    Type: String
    Default: gpt-4o-mini
  StateBucketName:
    Type: String
  StateBasePrefix:
    Type: String
    Default: prod
  AwsS3Endpoint:
    Type: String
    Default: http://localstack:4566
Resources:
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: common-dependencies
      ContentUri: ../../layers/common
      CompatibleRuntimes:
      - python3.11
      RetentionPolicy: Retain
  CrewAILayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: crewai-dependencies
      ContentUri: ../../layers/crewai
      CompatibleRuntimes:
      - python3.11
      RetentionPolicy: Retain
  NeMoLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: nemo-dependencies
      ContentUri: ../../layers/nemo
      CompatibleRuntimes:
      - python3.11
      RetentionPolicy: Retain
  StateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: StateBucketName
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
        - Id: ExpireOldState
          Status: Enabled
          ExpirationInDays: 7
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
        - '*'
        AllowMethods:
        - '*'
        AllowHeaders:
        - '*'
      DefaultRouteSettings:
        ThrottlingBurstLimit: 100
        ThrottlingRateLimit: 50
  SharedServicesFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: shared-services
      CodeUri: SharedServicesFn
      Handler: main.lambda_handler
      Layers:
      - Ref: CommonLayer
      - Ref: NeMoLayer
      MemorySize: 2048
      Timeout: 180
      ReservedConcurrentExecutions: 10
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: StateBucketName
      Environment:
        Variables:
          OPENAI_API_KEY:
            Ref: OpenAIKey
          S3_BUCKET_NAME:
            Ref: StateBucketName
          S3_BASE_PREFIX:
            Ref: StateBasePrefix
          GUARDRAILS_ENABLED: 'true'
          GUARDRAILS_TIMEOUT: '20'
      Events:
        SharedRoutes:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /shared/{proxy+}
        SecurityRoutes:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /security/{proxy+}
        SessionRoutes:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /session/{proxy+}
    Metadata:
      SamResourceId: SharedServicesFn
  IntentServiceFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: intent-requirements-service
      CodeUri: IntentServiceFn
      Handler: main.lambda_handler
      Layers:
      - Ref: CommonLayer
      - Ref: CrewAILayer
      MemorySize: 3008
      Timeout: 300
      ReservedConcurrentExecutions: 10
      EphemeralStorage:
        Size: 2048
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: StateBucketName
      Environment:
        Variables:
          OPENAI_API_KEY:
            Ref: OpenAIKey
          OPENAI_MODEL_NAME:
            Ref: ModelName
          S3_BUCKET_NAME:
            Ref: StateBucketName
          S3_BASE_PREFIX:
            Ref: StateBasePrefix
          S3_MEMORY_PREFIX: requirements/
          CREWAI_TELEMETRY_DISABLED: '1'
          MAX_TOKENS: '300'
      Events:
        IntentRoutes:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /intent/{proxy+}
    Metadata:
      SamResourceId: IntentServiceFn
  ApiGatewayFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: stp-api-gateway
      CodeUri: ApiGatewayFn
      Handler: main.lambda_handler
      Layers:
      - Ref: CommonLayer
      MemorySize: 1024
      Timeout: 330
      ReservedConcurrentExecutions: 20
      Policies:
      - LambdaInvokeFunction:
          FunctionName:
            Ref: SharedServicesFn
      - LambdaInvokeFunction:
          FunctionName:
            Ref: IntentServiceFn
      Environment:
        Variables:
          DOWNSTREAM_MODE: LAMBDA
          INTENT_SERVICE_LAMBDA:
            Ref: IntentServiceFn
          SHARED_SERVICES_LAMBDA:
            Ref: SharedServicesFn
      Events:
        TravelPlan:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: POST
            Path: /travel/plan
        SessionInfo:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: GET
            Path: /travel/session/{session_id}
        HealthCheck:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: GET
            Path: /health
    Metadata:
      SamResourceId: ApiGatewayFn
Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
